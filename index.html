<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>剣道スコア（最終最適化版）</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #eee; margin: 0; padding: 10px; }
        .no-print-container { max-width: 600px; margin: 0 auto; }
        .box { background: white; border-radius: 10px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .header-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .header-inputs input { width: 100%; box-sizing: border-box; font-size: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; color: #000; }
        
        .input-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
        .input-table th, .input-table td { border: 1px solid #ddd; padding: 4px; text-align: center; }
        .input-table th { background: #333; color: white; font-size: 11px; }
        .name-input { width: 100%; border: none; font-size: 18px; font-weight: bold; text-align: center; padding: 10px 0; background: #fdfdfd; color: #000; }
        
        .btn-group { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; margin-top: 3px; }
        button { font-size: 10px; padding: 12px 0; border: 1px solid #ccc; background: #f9f9f9; border-radius: 4px; cursor: pointer; }
        .btn-red { color: red; font-weight: bold; }
        .btn-blue { color: blue; font-weight: bold; }
        .btn-fusen { background: #fff3cd; color: #856404; font-weight: bold; }
        
        .pts-display { font-size: 20px; font-weight: bold; min-height: 28px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .hansoku-display { color: #555; font-size: 12px; min-height: 14px; }
        .circle-pt { border: 2px solid currentColor; border-radius: 50%; width: 1.3em; height: 1.3em; display: inline-block; line-height: 1.3em; text-align: center; }

        .btn-main { background: #d90429; color: white; padding: 15px; font-size: 18px; font-weight: bold; width: 100%; border: none; border-radius: 8px; margin-top: 10px; }
        .btn-all-clear { background: #6c757d; color: white; padding: 10px; font-size: 12px; border: none; border-radius: 5px; font-weight: bold; width: 100%; margin-top: 15px; }

        #history-area { width: 100%; max-width: 900px; margin: 0 auto; }
        .card-container { margin-bottom: 35px; position: relative; }
        .card { background: white; border: 2.5px solid #000; width: 100%; box-sizing: border-box; overflow: hidden; }
        .card-header { padding: 10px; border-bottom: 2px solid #000; background: #f8f8f8; display: flex; justify-content: space-between; align-items: flex-end; }
        
        .title-group { display: flex; flex-direction: column; text-align: left; }
        .card-comp { font-size: 20px; font-weight: 900; color: #000; line-height: 1.2; }
        .card-label { font-size: 14px; font-weight: bold; color: #666; margin-top: 2px; }
        .card-date { font-size: 13px; font-weight: bold; color: #333; }
        
        .history-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .history-table th, .history-table td { border: 1.5px solid #000; text-align: center; vertical-align: middle; color: #000; }
        .history-table th { background: #f0f0f0; font-size: 13px; height: 30px; }
        
        .p-name-bold { font-size: 18px; font-weight: 900; height: 24px; line-height: 24px; }
        .p-pts-box { font-size: 22px; font-weight: bold; height: 32px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .p-hansoku-box { font-size: 11px; height: 14px; color: #444; }

        .hantei-cell { font-weight: bold; }
        .hantei-mark { font-size: 22px; }
        .hantei-text { font-size: 11px; line-height: 1.1; }

        .print-summary { font-size: 20px; font-weight: bold; padding: 12px; text-align: center; border-top: 2.5px solid #000; background: #f0f0f0; color: #000; }
        .res-label { margin-left: 10px; padding: 2px 10px; border-radius: 4px; background: #000; color: #fff; font-size: 18px; }

        .card-actions-outer { display: flex; justify-content: flex-end; gap: 15px; margin-top: 8px; padding-right: 5px; }
        .edit-btn { background: #4caf50; color: white; border: none; border-radius: 6px; padding: 8px 16px; font-size: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .del-btn { background: #f44336; color: white; border: none; border-radius: 6px; padding: 8px 16px; font-size: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        @media print {
            .no-print, .card-actions-outer { display: none !important; }
            body { background: white; padding: 0; }
            .card-container { page-break-inside: avoid; margin-bottom: 15mm; }
        }
    </style>
</head>
<body>

<div class="no-print no-print-container">
    <div class="box">
        <div class="header-inputs">
            <input type="text" id="comp" placeholder="大会名" oninput="tempSave()">
            <input type="text" id="match" placeholder="区分（例：予選1）" oninput="tempSave()">
        </div>
        <div class="header-inputs">
            <input type="text" id="teamA" placeholder="自チーム" oninput="tempSave()">
            <input type="text" id="teamB" placeholder="相手チーム" oninput="tempSave()">
        </div>
        
        <table class="input-table">
            <thead>
                <tr><th width="15%">位置</th><th width="35%">選手名</th><th width="15%">勝敗</th><th width="35%">選手名</th></tr>
            </thead>
            <tbody id="input-body"></tbody>
        </table>
        
        <button class="btn-main" onclick="saveMatch()">試合結果を保存</button>
        <button class="btn-all-clear" onclick="clearMatchInfoOnly()">リセット</button>
    </div>
</div>

<div id="history-area"></div>

<div class="bottom-actions no-print" style="text-align:center; padding: 30px;">
    <button onclick="window.print()" style="padding:15px; background:#333; color:white; border-radius:8px; width:80%; font-weight:bold; cursor:pointer;">印刷・PDF保存</button>
</div>

<script>
    const positions = ["先鋒", "次鋒", "中堅", "副将", "大将", "代表"];
    let playerNames = positions.map(() => ({ nA: "", nB: "" }));
    let matchData = positions.map(() => ({ sA: [], sB: [], fA: 0, fB: 0, order: [] }));
    let matchHistory = [];

    function tempSave() {
        const data = { comp: document.getElementById('comp').value, match: document.getElementById('match').value, teamA: document.getElementById('teamA').value, teamB: document.getElementById('teamB').value, playerNames, matchData };
        localStorage.setItem('kendo_v6_temp', JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem('kendo_v6_temp');
        if (saved) {
            const d = JSON.parse(saved);
            document.getElementById('comp').value = d.comp || "";
            document.getElementById('match').value = d.match || "";
            document.getElementById('teamA').value = d.teamA || "";
            document.getElementById('teamB').value = d.teamB || "";
            playerNames = d.playerNames;
            matchData = d.matchData;
        }
        const hist = localStorage.getItem('kendo_v6_hist');
        if (hist) { matchHistory = JSON.parse(hist); updateHistoryDisplay(); }
        renderInput();
    }

    function renderInput() {
        const body = document.getElementById('input-body');
        body.innerHTML = matchData.map((d, i) => `
            <tr>
                <td rowspan="2" style="font-weight:bold; background:#f9f9f9;">${positions[i]}</td>
                <td><input type="text" class="name-input" value="${playerNames[i].nA}" onchange="playerNames[${i}].nA=this.value; tempSave();"></td>
                <td rowspan="2" style="font-size:11px; font-weight:bold;">${getResLabel(d.sA, d.sB)}</td>
                <td><input type="text" class="name-input" value="${playerNames[i].nB}" onchange="playerNames[${i}].nB=this.value; tempSave();"></td>
            </tr>
            <tr>
                <td>
                    <div class="hansoku-display">${"▲".repeat(d.fA)}</div>
                    <div class="pts-display" style="color:red">${formatPts(i, 'A')}</div>
                    <div class="btn-group">
                        <button class="btn-red" onclick="addP(${i},'A','メ')">面</button>
                        <button class="btn-red" onclick="addP(${i},'A','コ')">コ</button>
                        <button class="btn-red" onclick="addP(${i},'A','ド')">ド</button>
                        <button class="btn-fusen" onclick="setF(${i},'A')">不戦</button>
                        <button onclick="addHansoku(${i},'A')">反${d.fA > 0 ? d.fA : ''}</button>
                    </div>
                </td>
                <td>
                    <div class="hansoku-display">${"▲".repeat(d.fB)}</div>
                    <div class="pts-display" style="color:blue">${formatPts(i, 'B')}</div>
                    <div class="btn-group">
                        <button class="btn-blue" onclick="addP(${i},'B','メ')">面</button>
                        <button class="btn-blue" onclick="addP(${i},'B','コ')">コ</button>
                        <button class="btn-blue" onclick="addP(${i},'B','ド')">ド</button>
                        <button class="btn-fusen" onclick="setF(${i},'B')">不戦</button>
                        <button onclick="addHansoku(${i},'B')">反${d.fB > 0 ? d.fB : ''}</button>
                    </div>
                </td>
            </tr>
            <tr class="no-print"><td colspan="4" style="text-align:right;"><button onclick="undo(${i})">訂正</button></td></tr>
        `).join('');
    }

    function getResLabel(sA, sB) {
        if (sA.length > sB.length) return "〇";
        if (sB.length > sA.length) return "✕";
        return (sA.length > 0 || sB.length > 0) ? "引分" : "-";
    }

    function addHansoku(i, side) {
        if (matchData[i]['f' + side] < 4) {
            matchData[i]['f' + side]++;
            if (matchData[i]['f' + side] % 2 === 0) addP(i, side === 'A' ? 'B' : 'A', '反');
            tempSave(); renderInput();
        }
    }

    function formatPts(idx, side) {
        const row = matchData[idx];
        return row['s' + side].map((p, j) => {
            const isFirst = row.order[0]?.side === side && j === 0;
            return isFirst ? `<span class="circle-pt">${p}</span>` : `<span>${p}</span>`;
        }).join('');
    }

    function addP(i, side, pt) { if(matchData[i]['s'+side].length < 2) { matchData[i]['s'+side].push(pt); matchData[i].order.push({side, pt}); tempSave(); renderInput(); } }
    
    function setF(i, side) {
        matchData[i]['s'+side] = ['□', '□']; matchData[i][side==='A'?'sB':'sA'] = [];
        matchData[i].order = [{side, pt: 'FUSEN'}]; tempSave(); renderInput();
    }

    function undo(i) {
        const d = matchData[i];
        if (d.order.length > 0) {
            const last = d.order.pop();
            if (last.pt === 'FUSEN') d['s'+last.side] = [];
            else {
                d['s'+last.side].pop();
                if (last.pt === '反') d['f'+(last.side==='A'?'B':'A')] -= 2;
            }
        } else if (d.fA > 0) d.fA--; else if (d.fB > 0) d.fB--;
        tempSave(); renderInput();
    }

    function saveMatch() {
        const now = new Date();
        const currentMatch = {
            id: Date.now(),
            comp: document.getElementById('comp').value || "記録",
            label: document.getElementById('match').value || "",
            teamA: document.getElementById('teamA').value || "自チーム",
            teamB: document.getElementById('teamB').value || "相手チーム",
            date: now.getFullYear() + "/" + ("0"+(now.getMonth()+1)).slice(-2) + "/" + ("0"+now.getDate()).slice(-2),
            results: JSON.parse(JSON.stringify(matchData.map((d, i) => ({...d, nA: playerNames[i].nA, nB: playerNames[i].nB}))))
        };
        matchHistory.unshift(currentMatch);
        localStorage.setItem('kendo_v6_hist', JSON.stringify(matchHistory));
        updateHistoryDisplay();
        clearMatchInfoOnly(false);
    }

    function editMatch(id) {
        const m = matchHistory.find(x => x.id === id);
        if (m && confirm('この内容を編集エリアに戻しますか？')) {
            document.getElementById('comp').value = m.comp;
            document.getElementById('match').value = m.label;
            document.getElementById('teamA').value = m.teamA;
            document.getElementById('teamB').value = m.teamB;
            playerNames = m.results.map(r => ({ nA: r.nA, nB: r.nB }));
            matchData = JSON.parse(JSON.stringify(m.results));
            renderInput();
            window.scrollTo(0,0);
        }
    }

    function deleteHistory(id) {
        if(confirm('削除しますか？')) {
            matchHistory = matchHistory.filter(m => m.id !== id);
            localStorage.setItem('kendo_v6_hist', JSON.stringify(matchHistory));
            updateHistoryDisplay();
        }
    }

    function updateHistoryDisplay() {
        let html = '';
        matchHistory.forEach((m) => {
            let wA=0, wB=0, pA=0, pB=0;
            const rows = m.results.map((d) => {
                const ptsA = d.sA.map((p, j) => (d.order[0]?.side==='A'&&j===0) ? `<span class="circle-pt">${p}</span>` : p).join('');
                const ptsB = d.sB.map((p, j) => (d.order[0]?.side==='B'&&j===0) ? `<span class="circle-pt">${p}</span>` : p).join('');
                
                let displayMark = ""; 
                let subText = "";
                
                if (d.sA.length > d.sB.length) { 
                    displayMark = "〇"; wA++; 
                } else if (d.sB.length > d.sA.length) { 
                    displayMark = "✕"; wB++; 
                } else {
                    // 両者無得点、または同点（1-1など）の場合に「引き分け」を表示
                    subText = "引き分け";
                }
                
                pA += d.sA.length; pB += d.sB.length;
                return { ptsA, ptsB, displayMark, subText, nA: d.nA, nB: d.nB, fA: d.fA, fB: d.fB };
            });

            let resText = (wA > wB) ? "勝ち" : (wB > wA) ? "負け" : (pA > pB) ? "勝ち(本)" : (pB > pA) ? "負け(本)" : "引き分け";

            html += `
                <div class="card-container">
                    <div class="card">
                        <div class="card-header">
                            <div class="title-group">
                                <span class="card-comp">${m.comp}</span>
                                <span class="card-label">${m.label}</span>
                            </div>
                            <span class="card-date">${m.date}</span>
                        </div>
                        <table class="history-table">
                            <tr><th width="18%"></th>${positions.map(p => `<th>${p[0]}</th>`).join('')}</tr>
                            <tr>
                                <td class="print-team-name" style="font-weight:bold;">${m.teamA}</td>
                                ${rows.map(r => `<td><div class="p-name-bold">${r.nA}</div><div class="p-hansoku-box">${"▲".repeat(r.fA)}</div><div class="p-pts-box">${r.ptsA}</div></td>`).join('')}
                            </tr>
                            <tr><td style="font-size:11px; background:#f0f0f0;">勝敗</td>${rows.map(r => `
                                <td class="hantei-cell">
                                    <div class="hantei-mark">${r.displayMark}</div>
                                    <div class="hantei-text">${r.subText}</div>
                                </td>`).join('')}</tr>
                            <tr>
                                <td class="print-team-name" style="font-weight:bold;">${m.teamB}</td>
                                ${rows.map(r => `<td><div class="p-pts-box">${r.ptsB}</div><div class="p-hansoku-box">${"▲".repeat(r.fB)}</div><div class="p-name-bold">${r.nB}</div></td>`).join('')}
                            </tr>
                        </table>
                        <div class="print-summary">結果：${wA}(${pA}) ― ${wB}(${pB}) <span class="res-label">${resText}</span></div>
                    </div>
                    <div class="card-actions-outer no-print">
                        <button class="edit-btn" onclick="editMatch(${m.id})">修正</button>
                        <button class="del-btn" onclick="deleteHistory(${m.id})">削除</button>
                    </div>
                </div>`;
        });
        document.getElementById('history-area').innerHTML = html;
    }

    function clearMatchInfoOnly(ask=true) {
        if(!ask || confirm('入力をリセットしますか？')) {
            document.getElementById('match').value = ""; document.getElementById('teamB').value = "";
            playerNames = playerNames.map(p => ({ nA: p.nA, nB: "" }));
            matchData = positions.map(() => ({ sA: [], sB: [], fA: 0, fB: 0, order: [] }));
            tempSave(); renderInput();
        }
    }

    window.onload = loadData;
</script>
</body>
</html>
